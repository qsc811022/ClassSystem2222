ğŸ‰ å¤ªå¥½äº†ï¼Google ç™»å…¥ + JWT çµ‚æ–¼è·‘èµ·ä¾†äº†ï¼é€™æ˜¯ä¸€å€‹å¤§ milestone ğŸ‘ğŸ‘
æˆ‘å€‘å…ˆ commit é€²åº¦ï¼Œç„¶å¾Œæˆ‘ä¾†å¹«ä½ æ•´ç†ã€Œé€™æ¬¡æˆ‘å€‘æ”¹äº†ä»€éº¼ & ç‚ºä»€éº¼è¦é€™æ¨£åšã€ã€‚

âœ… Commit Message (å»ºè­°ç”¨è‹±æ–‡ï¼Œå°ˆæ¡ˆæ¯”è¼ƒå°ˆæ¥­)
feat(auth): integrate Google OAuth2 login with JWT support

- Added Google OAuth2 login using passport-google-oauth20
- Updated Users table: allow NULL for username and password (Google users donâ€™t need them)
- Updated User model: set allowNull for username/password
- Added JWT token generation after Google login
- Modified authRoutes.ts to return JWT (instead of session)
- Improved env.ts with requiredEnv() to ensure required ENV vars exist

ğŸ” æœ¬æ¬¡ä¿®æ”¹é‡é»æ•™å­¸
1. Users Table çµæ§‹èª¿æ•´

ä¹‹å‰å•é¡Œï¼šä½ çš„ Users è¡¨è£¡ username å’Œ password è¨­å®šæˆ NOT NULLã€‚
ä½† Google ç™»å…¥çš„ä½¿ç”¨è€…ä¸æœƒæœ‰é€™å…©å€‹æ¬„ä½ â†’ æ’å…¥è³‡æ–™æ™‚çˆ†ç‚¸ (500 Internal Server Error)ã€‚

è§£æ³•ï¼š

ALTER TABLE Users MODIFY COLUMN username VARCHAR(50) NULL;
ALTER TABLE Users MODIFY COLUMN password VARCHAR(255) NULL;


â†’ å…è¨± usernameã€password ç‚º NULLã€‚

2. User Model å°æ‡‰èª¿æ•´

åœ¨ src/models/User.ts åŠ ä¸Šï¼š

username: {
  type: DataTypes.STRING(50),
  unique: true,
  allowNull: true, // âœ… Google ä½¿ç”¨è€…æ²’æœ‰ username ä¹Ÿèƒ½å»ºç«‹
},
password: {
  type: DataTypes.STRING(255),
  allowNull: true, // âœ… Google ä½¿ç”¨è€…æ²’æœ‰ password
},


é€™æ¨£ DB è·Ÿ Model å°é½Šï¼Œä¸æœƒå†è¡çªã€‚

3. Google OAuth ç™»å…¥æµç¨‹

åœ¨ authRoutes.ts è£¡ï¼š

å…ˆå»æ‰¾æœ‰æ²’æœ‰ google_id ç›¸åŒçš„ä½¿ç”¨è€…ã€‚

æ²’æœ‰çš„è©±ï¼Œæ–°å¢ä¸€ç­† Userï¼ˆåªå­˜ google_id, email, name, role=studentï¼‰ã€‚

ç™»å…¥æˆåŠŸå¾Œï¼Œä¸å†ç”¨ sessionï¼Œè€Œæ˜¯ å›å‚³ JWTï¼š

const token = generateToken({
  user_id: user.user_id,
  role: user.role,
  email: user.email,
});

4. JWT æ”¯æ´

src/utils/jwt.ts â†’ è² è²¬ç”¢ç”Ÿèˆ‡é©—è­‰ Tokenã€‚

src/middlewares/auth.ts â†’ Middleware é©—è­‰ Tokenï¼Œä¿è­·éœ€è¦ç™»å…¥çš„ APIã€‚

5. env.ts å¼·åŒ–

å¢åŠ  requiredEnv()ï¼Œç¢ºä¿å¿…é ˆçš„ç’°å¢ƒè®Šæ•¸å­˜åœ¨ï¼Œé¿å… string | undefined çš„éŒ¯èª¤ã€‚

ğŸš€ æˆæœ

Google ä½¿ç”¨è€…å¯ä»¥ç›´æ¥ç™»å…¥ï¼ŒDB è£¡æœƒæ–°å¢ google_idã€emailã€nameã€‚

ä¸éœ€è¦ username/password â†’ ä¸æœƒå†å ± SQL errorã€‚

ç™»å…¥å¾Œå›å‚³ JWT â†’ å‰ç«¯å­˜ä¸‹ä¾†å°±èƒ½å‘¼å«å—ä¿è­·çš„ APIã€‚

é è¨­ Google è¨»å†Šä½¿ç”¨è€…è§’è‰² = studentï¼Œå®‰å…¨å¯æ§ã€‚


å¥½çš„ ğŸ‘ æˆ‘ä¾†å¹«ä½ æ•´ç†ç›®å‰çš„é€²åº¦ï¼Œä¸¦é™„ä¸Šå®Œæ•´çš„ API æ¸¬è©¦æ–¹å¼ï¼ˆç”¨ Postman / curl éƒ½èƒ½æ“ä½œï¼‰ã€‚

ğŸ“Œ ClassSystem å°ˆæ¡ˆé€²åº¦æ•´ç† (ç›®å‰åˆ° 2025/08/28)
âœ… å·²å®ŒæˆåŠŸèƒ½
1. ç’°å¢ƒè¨­ç½®

TypeScript + Express + Sequelize

MySQL è³‡æ–™åº«ï¼ˆclasshub1ï¼‰

dotenv ç®¡ç†ç’°å¢ƒè®Šæ•¸

tsx å•Ÿå‹•å°ˆæ¡ˆ (npx tsx src/index.ts)

2. User æ¨¡çµ„

DB Schema å·²åŒ…å«ï¼š

user_id, google_id, email, username, password, role, name, created_at

æ”¯æ´ Google OAuth ç™»å…¥

æ–°ç”¨æˆ¶æœƒè‡ªå‹•å»ºç«‹

é è¨­è§’è‰²ç‚º student

Admin å¸³è™Ÿå¯ä»¥åœ¨ DB æ‰‹å‹•è¨­å®š role = 'admin'

JWT ç™»å…¥å®Œæˆå¾Œï¼Œå›å‚³ï¼š

{
  "message": "Login successful",
  "token": "xxxxx.yyyyy.zzzzz",
  "user": {
    "id": 4,
    "name": "xxx",
    "email": "xxx@gmail.com",
    "role": "student"
  }
}

3. Course æ¨¡çµ„ (CRUD)

GET /api/courses/today â†’ æŸ¥è©¢ä»Šæ—¥èª²ç¨‹

GET /api/courses/week â†’ æŸ¥è©¢æœ¬é€±èª²ç¨‹

GET /api/courses/month â†’ æŸ¥è©¢æœ¬æœˆèª²ç¨‹

GET /api/courses â†’ æŸ¥è©¢æ‰€æœ‰èª²ç¨‹ï¼ˆéœ€ç™»å…¥ï¼‰

POST /api/courses â†’ å»ºç«‹æ–°èª²ç¨‹ï¼ˆé™ adminï¼‰

PUT /api/courses/:id â†’ æ›´æ–°èª²ç¨‹ï¼ˆé™ adminï¼‰

DELETE /api/courses/:id â†’ åˆªé™¤èª²ç¨‹ï¼ˆé™ adminï¼‰

ğŸ‘‰ RBAC (Role-Based Access Control)

student â†’ åªèƒ½ GET

admin â†’ å¯ä»¥ GET / POST / PUT / DELETE

ğŸ§ª API æ¸¬è©¦æ–¹å¼
1. Google ç™»å…¥ (å–å¾— JWT)

GET
http://localhost:3000/auth/google

å®Œæˆç™»å…¥å¾Œï¼Œæœƒ redirect åˆ° callbackï¼Œä¸¦å›å‚³ tokenã€‚
ï¼ˆå¯ä»¥åœ¨ response JSON å…§ copy tokenï¼‰

2. å¸¶ Token æ¸¬è©¦ API

åœ¨ Postman / curl çš„ Headers åŠ ä¸Šï¼š

Authorization: Bearer <ä½ çš„token>

3. èª²ç¨‹æŸ¥è©¢ (å­¸ç”Ÿå¯ç”¨)
GET http://localhost:3000/api/courses/today
GET http://localhost:3000/api/courses/week
GET http://localhost:3000/api/courses/month
GET http://localhost:3000/api/courses

4. å»ºç«‹èª²ç¨‹ (åªæœ‰ admin å¯ç”¨)
POST http://localhost:3000/api/courses
Content-Type: application/json
Authorization: Bearer <admin_token>

Body:
{
  "title": "Math Basics",
  "start_time": "2025-09-01T09:00:00Z",
  "end_time": "2025-09-01T12:00:00Z",
  "classroom_id": 1,
  "instructor_id": 1
}


å›æ‡‰ï¼š

{
  "course_id": 2,
  "title": "Math Basics",
  "start_time": "...",
  "end_time": "...",
  "classroom_id": 1,
  "instructor_id": 1,
  "created_at": "..."
}

5. æ›´æ–°èª²ç¨‹ (åªæœ‰ admin å¯ç”¨)
PUT http://localhost:3000/api/courses/2
Content-Type: application/json
Authorization: Bearer <admin_token>

Body:
{
  "title": "Math Basics - Updated",
  "start_time": "2025-09-01T09:00:00Z",
  "end_time": "2025-09-01T11:00:00Z",
  "classroom_id": 1,
  "instructor_id": 1
}

6. åˆªé™¤èª²ç¨‹ (åªæœ‰ admin å¯ç”¨)
DELETE http://localhost:3000/api/courses/2
Authorization: Bearer <admin_token>


æˆåŠŸæœƒå›æ‡‰ï¼š

{ "message": "Course deleted successfully" }

âš¡ æ¸¬è©¦æµç¨‹å»ºè­°

ç”¨ Google ç™»å…¥ â†’ å–å¾— student token
â†’ æ¸¬è©¦ GET OKï¼ŒPOST/PUT/DELETE æœƒ 403 (ç¬¦åˆé æœŸ)

åˆ° DB ä¿®æ”¹æŸå€‹ä½¿ç”¨è€…çš„ role = 'admin'
â†’ ç”¨é€™å€‹å¸³è™Ÿé‡æ–°ç™»å…¥ Google â†’ å–å¾— admin token

ç”¨ admin token æ¸¬è©¦

POST æ–°å¢èª²ç¨‹

GET æŸ¥è©¢èª²ç¨‹

PUT æ›´æ–°èª²ç¨‹

DELETE åˆªé™¤èª²ç¨‹

é€™æ¨£ï¼Œä½ å°±èƒ½å®Œæ•´é©—è­‰ ç™»å…¥ â†’ æ¬Šé™æ§åˆ¶ â†’ CRUD API çš„æµç¨‹ ğŸ¯

è¦ä¸è¦æˆ‘å¹«ä½ æ•´ç†ä¸€ä»½ Postman Collection (JSON æª”)ï¼Œè®“ä½ ç›´æ¥åŒ¯å…¥å°±èƒ½ä¸€éµæ¸¬è©¦æ‰€æœ‰ APIï¼Ÿ